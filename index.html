<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOUTH VALLEY Command Center</title>
    <!-- Chargement de Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* DÃ©finition de l'URL de l'image de fond */
        :root {
            --bg-image-url: url('https://res.cloudinary.com/dlmmylat6/image/upload/v1764908117/Design_sans_titre_1_lhtsct.png'); /* NOUVEAU FOND STYLISÃ‰ (Fond gÃ©nÃ©ral) */
            --logo-overlay-url: url('https://res.cloudinary.com/dlmmylat6/image/upload/v1764909554/Sans_titre_Logo_r1rnq7.png'); /* NOUVEAU LOGO FLOTTANT */
            --color-primary: #10B981; /* Vert Ã‰meraude (Action/Hash&Zaza) */
            --color-secondary: #94A3B8; /* NOUVEAU: Gris Ardoise/Argent (AccÃ¨s/Snow) */
            --color-bg: #111827; /* Gris foncÃ©/Noir */
            --color-text: #F9FAFB; /* Blanc */
        }
        body { 
            background-color: var(--color-bg); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
            /* APPLICATION DU FOND STYLISÃ‰ */
            background-image: var(--bg-image-url);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed; /* Reste fixe en scrollant */
        }
        /* Rendre l'application Semi-Transparente pour le Dark Mode */
        #appContainer {
            /* Garder une lÃ©gÃ¨re transparence pour laisser l'image de fond visible */
            background-color: rgba(17, 24, 39, 0.9); 
            min-height: 100vh;
        }
        /* Style pour simuler l'intÃ©gration TMA (ajustement de la barre de navigation) */
        .bottom-nav, header { 
            background-color: rgba(31, 41, 55, 0.95); /* Navigation plus opaque */
        }
        .loading-screen {
            background-color: var(--color-bg);
            z-index: 100;
        }
        /* Styles pour la vidÃ©o de chargement */
        .video-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            opacity: 0.2; /* Rend le fond subtil */
        }
        .video-container video {
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .loading-content {
            z-index: 10; /* Assure que le texte est au-dessus de la vidÃ©o */
        }
        /* --- ICÃ”NES CORPORATE --- */
        .icon-menu::before { content: 'â˜°'; font-size: 20px; line-height: 1; }
        .icon-cart::before { content: 'ğŸ“¦'; font-size: 20px; line-height: 1; }
        .icon-contact::before { content: 'ğŸ“'; font-size: 20px; line-height: 1; }
        .icon-cart-header::before { content: 'ğŸ“¦'; }

        /* Styles pour les points qui sautillent (Loading Dots) */
        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--color-secondary);
            margin: 0 4px;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body>

<!-- Chargement du SDK Telegram Mini App (Crucial pour l'interaction avec le bot) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Ã‰cran de Chargement (Splash Screen) -->
<div id="loadingScreen" class="loading-screen fixed inset-0 flex flex-col items-center justify-center p-6 text-white transition-opacity duration-500">
    <!-- VidÃ©o de transition en fond (Remplacer l'URL par votre vidÃ©o hÃ©bergÃ©e) -->
    <div class="video-container">
        <!-- URL Cloudinary pour la vidÃ©o de transition -->
        <video id="logoVideo" src="https://res.cloudinary.com/dlmmylat6/video/upload/v1764906501/Hailuo_Video_Please_try_to_make_the_image_m_449765216579096579_2_z65kit.mov" loop muted playsinline autoplay onerror="console.log('ERREUR: VidÃ©o de logo non trouvÃ©e. Utiliser une URL de fichier .mp4 hÃ©bergÃ©e publiquement.')"></video>
    </div>

    <div class="loading-content relative flex flex-col items-center justify-center">
        <h1 class="text-4xl font-extrabold mt-4" style="color: var(--color-secondary);">SOUTH VALLEY ğŸœï¸</h1>
        <p class="text-lg mt-1 font-semibold" style="color: var(--color-primary);">COMMAND CENTER</p>
        
        <!-- NOUVEAU: Points qui sautillent -->
        <div class="mt-8 flex items-center">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>
        <p id="loadingText" class="text-xs mt-3 text-gray-400">VÃ©rification de la SÃ©curitÃ© en cours...</p>
    </div>
</div>


<!-- Contenu de la Mini App -->
<div id="appContainer" class="min-h-screen pb-16 hidden">

    <!-- Header (Titre) -->
    <header class="p-4 border-b border-gray-700 flex justify-between items-center sticky top-0 z-10" style="background-color: #1f2937;">
        <h1 class="text-xl font-bold" style="color: var(--color-primary);">SOUTH VALLEY ğŸ•ï¸</h1>
        <button onclick="changeScreen('cart')" class="text-white hover:text-yellow-400 transition-colors">
            <span class="icon-cart-header text-2xl" role="img" aria-label="Panier"></span>
            <span id="cartCount" class="text-xs bg-red-600 rounded-full px-2 py-0.5 ml-1">0</span>
        </button>
    </header>

    <!-- Zone de Contenu (Affichage des Ã‰crans) -->
    <main id="mainContent" class="p-4">
        <!-- Les diffÃ©rents Ã©crans seront injectÃ©s ici -->
    </main>

    <!-- Navigation du Bas (Footer) -->
    <footer class="bottom-nav fixed bottom-0 left-0 right-0 h-16 flex justify-around items-center border-t border-gray-700 text-gray-400 text-xs z-20">
        <button onclick="changeScreen('menu')" class="flex flex-col items-center hover:text-white transition-colors">
            <span class="icon-menu"></span> Menu
        </button>
        <button onclick="changeScreen('cart')" class="flex flex-col items-center hover:text-white transition-colors">
            <span class="icon-cart"></span> Panier
        </button>
        <button onclick="changeScreen('contact')" class="flex flex-col items-center hover:text-white transition-colors">
            <span class="icon-contact"></span> Contact
        </button>
    </footer>

    <!-- Modal pour la sÃ©lection des tiers de produits -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-30 p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl text-white">
            <h3 id="modalTitle" class="text-2xl font-extrabold mb-4" style="color: var(--color-secondary);"></h3>
            
            <!-- Conteneur VidÃ©o -->
            <div id="videoContainerModal" class="mb-4 aspect-video bg-black rounded-lg overflow-hidden">
                <video id="productVideo" src="" controls muted class="w-full h-full object-cover"></video>
            </div>
            
            <p id="modalDesc" class="text-sm text-gray-400 mb-4"></p>
            
            <div id="tiersContainer" class="space-y-3 max-h-48 overflow-y-auto pr-2">
                <!-- Tiers injectÃ©s ici -->
            </div>

            <button onclick="closeModal()" class="mt-6 w-full py-3 font-bold rounded-xl bg-gray-700 hover:bg-gray-600 transition-colors">
                ANNULER / FERMER
            </button>
        </div>
    </div>
</div>

<script>
    // --- VARIABLES GLOBALES ---
    let currentScreen = 'menu';
    let cart = [];
    let securityCode = ''; // Code de sÃ©curitÃ© gÃ©nÃ©rÃ© pour la commande
    
    // DÃ©finition de la structure complexe des produits
    const productData = [
        { 
            id: 'MC', 
            name: 'MONTÃ‰ CRISTO', 
            category: 'Snow Valley', 
            icon: 'â˜ƒï¸',
            // URL VidÃ©o : Cloudinary
            videoUrl: 'https://res.cloudinary.com/dlmmylat6/video/upload/v1764906305/IMG_1629_ntkjra.mp4', 
            // URL Miniature (Placeholder)
            thumbnailUrl: 'https://placehold.co/64x64/94A3B8/111827?text=S-MC',
            desc: 'Un arrivage givrÃ©e ğŸ¥¶ - venu tout droit de Bolivie ğŸ‡§ğŸ‡´, ce MontÃ© Cristoâ€™ frÃ´le la puretÃ© avec un taux de 0.98% ! ğŸŒ¬ï¸',
            tiers: [
                { w: '1.G', p: 60 }, { w: '2.G', p: 120 }, { w: '3.G', p: 160 }, 
                { w: '5.G', p: 260 }, { w: '10.G', p: 400 }, { w: '50.G', p: 1500 }, 
                { w: '100.G', p: 2800 }
            ]
        },
        { 
            id: 'PK', 
            name: 'Pink Kush', 
            category: 'Hash & Zaza Valley', 
            icon: 'ğŸ§¬',
            // URL VidÃ©o : Cloudinary
            videoUrl: 'https://res.cloudinary.com/dlmmylat6/video/upload/v1764906290/06AECEF5-7C0A-493C-9588-99433B454A4E_2_1_hnlzee.mov', 
            // URL Miniature (Placeholder)
            thumbnailUrl: 'https://placehold.co/64x64/10B981/111827?text=H-PK',
            desc: 'Restock de cette Cali tout droit venu de nos amis Californiens ğŸ‡ºğŸ‡¸, un taux atteignant les 34% de THC ! ğŸŒ¬ï¸',
            tiers: [
                { w: '5.G', p: 60 }, { w: '10.G', p: 120 }, { w: '25.G', p: 220 }, 
                { w: '50.G', p: 360 }, { w: '100.G', p: 640 }, { w: '500.G', p: 2200 }
            ]
        },
        { 
            id: 'SM', 
            name: 'SIMPSONS MOUSSE 2K25', 
            category: 'Hash & Zaza Valley', 
            icon: 'ğŸ§½',
            // URL VidÃ©o : Cloudinary
            videoUrl: 'https://res.cloudinary.com/dlmmylat6/video/upload/v1764906298/IMG_1715_rtit70.mp4', 
            // URL Miniature (Placeholder)
            thumbnailUrl: 'https://placehold.co/64x64/10B981/111827?text=H-SM',
            desc: 'Nouvel arrivage Simpsons Mousse ğŸ§½ğŸ¥‡ la famille, Mousse de qualitÃ©, Ã  consommer sans modÃ©ration !ğŸ«§',
            tiers: [
                { w: '10.G', p: 60 }, { w: '20.G', p: 100 }, { w: '50.G', p: 170 }, 
                { w: '100.G', p: 350 }
            ]
        },
        { 
            id: 'XM', 
            name: 'XALEâ€™ MOUSSE', 
            category: 'Hash & Zaza Valley', 
            icon: 'ğŸ§½',
            // URL VidÃ©o : Cloudinary
            videoUrl: 'https://res.cloudinary.com/dlmmylat6/video/upload/v1764906313/IMG_1819_i4ipsf.mp4', 
            // URL Miniature (Placeholder)
            thumbnailUrl: 'https://placehold.co/64x64/10B981/111827?text=H-XM',
            desc: 'Nouvel arrivage mousseux ğŸ§¼, Top jaune mousseux, sâ€™effrite facilement, fumette de qualitÃ© assurÃ©e ! ğŸ¤',
            tiers: [
                { w: '10.G', p: 60 }, { w: '20.G', p: 100 }, { w: '50.G', p: 160 }, 
                { w: '100.G', p: 330 }
            ]
        }
    ];

    // Mappage des IDs/CatÃ©gories pour la navigation
    const productsByCategory = {
        'Hash & Zaza Valley': productData.filter(p => p.category === 'Hash & Zaza Valley'),
        'Snow Valley': productData.filter(p => p.category === 'Snow Valley')
    };

    // --- LOGIQUE UTILITAIRE ---
    
    /** Met Ã  jour le compteur du panier dans le header */
    function updateCartDisplay() {
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cartCount').textContent = count;
    }

    /** GÃ©nÃ¨re un code de sÃ©curitÃ© unique SV + 4 chiffres */
    function generateSecurityCode() {
        const randomDigits = Math.floor(1000 + Math.random() * 9000);
        return `SV${randomDigits}`;
    }

    // --- LOGIQUE D'AFFICHAGE ET DE NAVIGATION ---

    /** Affiche l'Ã©cran sÃ©lectionnÃ© */
    function changeScreen(screenName, category = null) {
        currentScreen = screenName;
        const content = document.getElementById('mainContent');
        content.innerHTML = '';
        window.scrollTo(0, 0); 

        // Style pour indiquer l'Ã©cran actif (non implÃ©mentÃ© pour la dÃ©mo, mais bonne pratique)
        // document.querySelectorAll('.bottom-nav button').forEach(btn => {/*...*/});

        switch (screenName) {
            case 'menu':
                content.innerHTML = renderMenuScreen();
                break;
            case 'products':
                content.innerHTML = renderProductsScreen(category);
                break;
            case 'cart':
                content.innerHTML = renderCartScreen();
                break;
            case 'checkout':
                // GÃ©nÃ©rer le code de sÃ©curitÃ© AVANT l'affichage du checkout
                securityCode = generateSecurityCode();
                content.innerHTML = renderCheckoutScreen();
                break;
            case 'contact':
                content.innerHTML = renderContactScreen();
                break;
            case 'success':
                content.innerHTML = renderSuccessScreen();
                break;
            default:
                content.innerHTML = renderMenuScreen();
        }
    }

    /** Ã‰cran principal avec les deux catÃ©gories */
    function renderMenuScreen() {
        return `
            <div class="text-white">
                <!-- LOGO FLOTTANT (visible au-dessus du fond, positionnÃ©) -->
                <div id="logoOverlay" class="w-full mb-4"></div>
                
                <h2 class="text-xl font-bold text-white text-center mb-6">DÃ‰COUVREZ NOS MENUS !</h2>
                
                <!-- Hash & Zaza Valley (Utilisation des classes pour la taille) -->
                <div onclick="changeScreen('products', 'Hash & Zaza Valley')" class="mb-4 p-4 rounded-xl cursor-pointer transition-transform hover:scale-[1.02] shadow-lg h-32 flex flex-col justify-center" style="background-color: #1f2937; border-left: 5px solid var(--color-primary);">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold" style="color: var(--color-primary);">Hash & Zaza Valley ğŸª´ğŸ˜®â€ğŸ’¨</h3>
                            <p class="text-sm text-gray-300">SÃ©lection de QualitÃ© & Premium | Coffee Quality CertifiÃ© ğŸ…</p>
                        </div>
                        <span class="text-3xl">ğŸš€</span>
                    </div>
                </div>

                <!-- Snow Valley -->
                <div onclick="changeScreen('products', 'Snow Valley')" class="mb-4 p-4 rounded-xl cursor-pointer transition-transform hover:scale-[1.02] shadow-lg" style="background-color: #1f2937; border-left: 5px solid var(--color-secondary);">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold" style="color: var(--color-secondary);">Snow Valley ğŸ”ï¸ğŸŒ¬ï¸</h3>
                            <p class="text-sm text-gray-300">Une expÃ©rience givrÃ©e & unique | PuretÃ© Garantie ! ğŸ…</p>
                        </div>
                        <span class="text-3xl">ğŸ’</span>
                    </div>
                </div>
                
                <!-- Statut de SÃ©curitÃ© (DÃ©placÃ© en bas du contenu) -->
                <h2 class="text-xl font-bold mt-8 mb-2 text-center" style="color: var(--color-secondary);">PLUG CERTIFIÃ‰ DEPUIS 2021 ğŸ”Œ</h2>
            </div>
        `;
    }

    /** Ã‰cran des produits pour une catÃ©gorie donnÃ©e */
    function renderProductsScreen(category) {
        const productList = productsByCategory[category] || [];
        const color = category === 'Hash & Zaza Valley' ? 'var(--color-primary)' : 'var(--color-secondary)';
        
        return `
            <button onclick="changeScreen('menu')" class="text-gray-400 hover:text-white mb-4 flex items-center">
                <span class="text-xl mr-2">â¬…ï¸</span> Retour Menu
            </button>
            <h2 class="text-3xl font-extrabold mb-6 text-white" style="color: ${color};">${category} ğŸ•ï¸</h2>
            
            <div class="grid grid-cols-1 gap-4">
                ${productList.map(p => {
                    const lowestTier = p.tiers[0];
                    return `
                        <div class="bg-gray-800 rounded-lg p-4 shadow-xl flex items-center space-x-4">
                            <!-- Miniature VidÃ©o/Image -->
                            <div class="w-20 h-20 bg-black rounded-lg flex-shrink-0 relative overflow-hidden" onclick="openModal('${p.id}')">
                                <!-- La vidÃ©o joue en boucle comme miniature -->
                                <video src="${p.videoUrl}" loop muted playsinline autoplay class="w-full h-full object-cover"></video>
                                <span class="absolute inset-0 flex items-center justify-center text-4xl text-white opacity-0 hover:opacity-100 transition-opacity duration-300 cursor-pointer">ğŸ‘ï¸</span>
                            </div>

                            <!-- Infos Produit -->
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-white mb-1">${p.icon} ${p.name}</h3>
                                <p class="text-sm text-gray-400 mb-2">${p.desc.length > 50 ? p.desc.substring(0, 50) + '...' : p.desc}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-extrabold" style="color: ${color};">${lowestTier.p}â‚¬ / ${lowestTier.w}</span>
                                    <button onclick="openModal('${p.id}')" class="bg-yellow-600 text-black px-3 py-1 rounded-full font-bold hover:bg-yellow-700 transition-colors flex items-center text-sm">
                                        Choisir â¡ï¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    /** Ouvre le modal de sÃ©lection des tiers de prix et charge la vidÃ©o */
    function openModal(productId) {
        const product = productData.find(p => p.id === productId);
        if (!product) return;

        document.getElementById('modalTitle').textContent = `${product.icon} ${product.name}`;
        document.getElementById('modalDesc').textContent = product.desc;

        // Afficher la vidÃ©o
        const videoElement = document.getElementById('productVideo');
        videoElement.src = product.videoUrl;
        
        // Charger la vidÃ©o mais ne pas dÃ©marrer la lecture (l'utilisateur doit cliquer)
        videoElement.load();

        const tiersHTML = product.tiers.map(tier => `
            <div class="flex justify-between items-center p-3 rounded-lg bg-gray-700">
                <span class="font-semibold">${tier.w}</span>
                <span class="font-extrabold" style="color: var(--color-primary);">${tier.p}â‚¬</span>
                <button 
                    onclick="addToCart('${product.id}_${tier.w}', '${product.name} (${tier.w})', ${tier.p})" 
                    class="bg-green-600 text-white px-3 py-1 text-sm rounded-full hover:bg-green-700 transition-colors"
                >
                    Ajouter ğŸ›’
                </button>
            </div>
        `).join('');

        document.getElementById('tiersContainer').innerHTML = tiersHTML;
        document.getElementById('productModal').classList.remove('hidden');
    }

    /** Ferme le modal */
    function closeModal() {
        // Stopper la vidÃ©o quand le modal est fermÃ©
        const videoElement = document.getElementById('productVideo');
        videoElement.pause();
        document.getElementById('productModal').classList.add('hidden');
    }

    /** Ã‰cran du Panier est le mÃªme mais utilise la nouvelle structure */
    function renderCartScreen() {
        // ... (Pas de changement majeur, la structure existante fonctionne pour l'affichage)
        if (cart.length === 0) {
            return `
                <h2 class="text-3xl font-extrabold mb-6 text-white">ğŸ“¦ Mon Panier</h2>
                <div class="text-center p-10 bg-gray-800 rounded-lg text-gray-400">
                    <p class="text-xl">Votre panier est vide.</p>
                    <p class="mt-2">Ajoutez des produits de la sÃ©lection Prestige pour commander.</p>
                    <button onclick="changeScreen('menu')" class="mt-6 text-sm text-yellow-400 hover:text-yellow-500">
                        Explorer le Catalogue
                    </button>
                </div>
            `;
        }

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        return `
            <h2 class="text-3xl font-extrabold mb-6 text-white">ğŸ“¦ Mon Panier</h2>
            <div class="space-y-4">
                ${cart.map((item, index) => `
                    <div class="bg-gray-800 rounded-lg p-3 flex justify-between items-center text-white">
                        <div class="flex-1">
                            <p class="font-bold">${item.name}</p>
                            <p class="text-sm text-gray-400">${item.price}â‚¬ x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateQuantity(${index}, -1)" class="text-xl bg-gray-700 w-8 h-8 rounded-full">-</button>
                            <span class="w-4 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity(${index}, 1)" class="text-xl bg-gray-700 w-8 h-8 rounded-full">+</button>
                            <button onclick="removeItem(${index})" class="text-red-500 hover:text-red-400 ml-3">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="mt-8 p-4 bg-gray-800 rounded-lg text-white">
                <p class="text-xl font-bold">TOTAL : <span class="float-right" style="color: var(--color-secondary);">${total}â‚¬</span></p>
            </div>

            <button onclick="changeScreen('checkout')" class="mt-6 w-full py-4 text-lg font-bold rounded-xl text-black transition-colors bg-yellow-400 hover:bg-yellow-500">
                PASSER AU CHECKOUT SÃ‰CURISÃ‰ ğŸ’³
            </button>
        `;
    }


    /** Ã‰cran de Paiement et Checkout */
    function renderCheckoutScreen() {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        // Construction du rÃ©sumÃ© pour WhatsApp
        const orderDetails = cart.map(item => `   - ${item.quantity}x ${item.name} (${item.price}â‚¬/u)`).join('\n');
        
        // DÃ©finir la fonction submitOrderWA comme callback pour le lien A
        const waLinkHref = "javascript:submitOrderWA(event);";

        return `
            <button onclick="changeScreen('cart')" class="text-gray-400 hover:text-white mb-4 flex items-center">
                <span class="text-xl mr-2">â¬…ï¸</span> Retour Panier
            </button>
            <h2 class="text-3xl font-extrabold mb-6 text-white">ğŸ”’ CHECKOUT SÃ‰CURISÃ‰</h2>
            
            <div class="space-y-4 text-white">
                <p class="text-xl font-bold mb-4">TOTAL Ã€ PAYER : <span style="color: var(--color-primary);">${total}â‚¬</span></p>

                <!-- VÃ©rification obligatoire -->
                <div class="p-3 rounded-lg text-sm bg-red-800 bg-opacity-30 border border-red-700">
                    <h3 class="font-bold text-red-400 mb-1">âš ï¸ VÃ‰RIFICATION OBLIGATOIRE</h3>
                    <p class="text-xs text-gray-300">Pour toute <b>premiÃ¨re commande</b>, la validation finale nÃ©cessite l'envoi d'une photo de votre **CNI & un Selfie** au Standard WhatsApp. Protocole de sÃ©curitÃ©. ğŸ›¡ï¸</p>
                </div>


                <!-- RÃ©sumÃ© de la Commande (Affichage) -->
                <h3 class="text-xl font-bold mt-6 mb-3" style="color: var(--color-secondary);">RÃ‰SUMÃ‰ DE L'ORDRE</h3>
                <div class="p-3 bg-gray-800 rounded-lg text-sm">
                    ${cart.map(item => `<p class="text-gray-300">${item.quantity}x ${item.name} (${item.price}â‚¬/u)</p>`).join('')}
                </div>
                <p class="text-lg font-bold mt-3">TOTAL: <span class="float-right" style="color: var(--color-primary);">${total}â‚¬</span></p>

                <!-- Formulaire de Contact -->
                <h3 class="text-xl font-bold mt-6 mb-3" style="color: var(--color-secondary);">1. Contact (Protocole)</h3>
                <input type="text" id="telegramPseudo" placeholder="Pseudo Telegram (Requis)" class="w-full p-3 rounded bg-gray-800 border border-gray-700 focus:ring-yellow-400 focus:border-yellow-400">
                <input type="text" id="contactNumber" placeholder="NumÃ©ro WhatsApp/Telegram (Requis)" class="w-full p-3 rounded bg-gray-800 border border-gray-700 focus:ring-yellow-400 focus:focus:border-yellow-400">
                <p class="text-xs text-gray-400 mt-1">Ceci garantit la discrÃ©tion et le suivi de votre ordre. ğŸ“²</p>

                <!-- Formulaire de Livraison -->
                <h3 class="text-xl font-bold mt-6 mb-3" style="color: var(--color-secondary);">2. Adresse de Livraison</h3>
                <input type="text" id="shippingName" placeholder="Nom Complet pour l'envoi (Requis)" class="w-full p-3 rounded bg-gray-800 border border-gray-700 focus:ring-yellow-400 focus:focus:border-yellow-400">
                <input type="text" id="shippingAddress" placeholder="Adresse complÃ¨te (Rue, Ville, Code Postal)" class="w-full p-3 rounded bg-gray-800 border border-gray-700 focus:ring-yellow-400 focus:border-yellow-400">
                
                <!-- Choix du Paiement -->
                <h3 class="text-xl font-bold mt-6 mb-3" style="color: var(--color-secondary);">3. MÃ©thode de Paiement</h3>
                <div class="flex space-x-4">
                    <button id="paymentCash" onclick="setPayment('CASH')" class="flex-1 py-3 px-4 rounded-lg font-bold transition-all border-2 border-gray-700 text-gray-400 hover:border-yellow-400">
                        <span class="text-2xl">ğŸ’µ</span> CASH (Meet-up/Livraison)
                    </button>
                    <button id="paymentCrypto" onclick="setPayment('CRYPTO')" class="flex-1 py-3 px-4 rounded-lg font-bold transition-all border-2 border-gray-700 text-gray-400 hover:border-yellow-400">
                        <span class="text-2xl">â‚¿</span> CRYPTO (Postal)
                    </button>
                </div>
                <input type="hidden" id="paymentMethod" value="">
                
                <div id="policyContainer" class="mt-4 p-3 rounded-lg text-sm" style="background-color: #2D3748;">
                    <p class="font-bold text-white">Politique de Paiement :</p>
                    <p id="paymentPolicy" class="text-gray-300 mt-1 text-xs">Veuillez sÃ©lectionner une mÃ©thode pour afficher la politique de sÃ©curitÃ© associÃ©e. ğŸ›¡ï¸</p>
                </div>


                <a id="waLinkCheckout" href="${waLinkHref}" target="_blank" onclick="submitOrderWA(event)" class="mt-8 w-full py-4 text-lg font-bold rounded-xl text-white transition-colors bg-green-600 hover:bg-green-700 flex items-center justify-center">
                    <span class="text-2xl mr-2">ğŸŸ¢</span> VALIDER MA COMMANDE
                </a>
            </div>
        `;
    }
    
    /** Ã‰cran Contact */
    function renderContactScreen() {
        // DÃ©finition de la couleur pour les titres secondaires des modalitÃ©s (Vert Emeraude, couleur primaire)
        const secondaryColor = 'var(--color-primary)'; 
        
        // Contenu des diffÃ©rentes sections du Bot de base
        const reseauxContent = `
            <h3 class="text-xl font-bold mt-2 mb-2" style="color: ${secondaryColor};">ğŸŒ Nos RÃ©seaux</h3>
            <p class="text-gray-300">Retrouvez-nous sur nos diffÃ©rentes plateformes pour suivre nos actualitÃ©s et rester connectÃ© Ã  South Valley ! ğŸœï¸</p>
            <div class="mt-3 space-y-2">
                <a href="https://t.me/SouthValleyFarm" target="_blank" class="block py-2 rounded-lg font-bold bg-blue-600 text-white text-center">Canal Telegram Officiel ğŸ”µ</a>
                <a href="https://dympt.org/SouthV" target="_blank" class="block py-2 rounded-lg font-bold bg-gray-700 text-white text-center">POTATO ğŸ¥”</a>
                <a href="https://wa.me/33759840764" target="_blank" class="block py-2 rounded-lg font-bold bg-green-600 text-white text-center">What'sApp ğŸŸ¢</a>
                <a href="https://linktr.ee/southvalleyfarm" target="_blank" class="mt-3 block py-2 rounded-lg font-bold bg-yellow-600 text-black text-center">ğŸ“² Tous nos rÃ©seaux</a>
            </div>
        `;

        const meetUpContent = `
            <h3 class="text-xl font-bold mt-6 mb-2" style="color: ${secondaryColor};">ğŸ¤ M33T-UP South Valley</h3>
            <p class="text-gray-300">Nos meet-ups se dÃ©roulent dans le 92, Ã  une adresse discrÃ¨te et sans vis-Ã -vis pour garantir votre confort et votre sÃ©curitÃ©. ğŸ˜‡</p>
            <p class="text-gray-300">Desservie par la Ligne 13 - RER C & RER L ! ğŸ¥‡</p>
            <p class="text-gray-300 mt-2">ğŸ•°ï¸ Horaires : 10:30 Ã  2:00</p>
            <h4 class="font-bold mt-4" style="color: var(--color-secondary);">ğŸ“Œ ModalitÃ©s de commande :</h4>
            <ol class="list-decimal list-inside text-gray-400 text-sm space-y-1">
                <li>ğŸ†” VÃ©rification dâ€™identitÃ© obligatoire pour les nouveaux arrivants.</li>
                <li>ğŸ› Consulte le menu via notre bot & diffÃ©rents canaux.</li>
                <li>âœï¸ Envoie ta commande complÃ¨te.</li>
                <li>ğŸ’¬ On te communique lâ€™adresse & lâ€™itinÃ©raire.</li>
                <li>ğŸš¶â€â™‚ï¸Tu passes rÃ©cupÃ©rer ta commande.</li>
            </ol>
        `;

        const livraisonContent = `
            <h3 class="text-xl font-bold mt-6 mb-2" style="color: ${secondaryColor};">ğŸ“¦ Livraisons South Valley ! ğŸœï¸</h3>
            <p class="text-gray-300">Nous desservons toute lâ€™Ãle-de-France et certaines zones hors IDF.</p>
            <h4 class="font-bold mt-4" style="color: var(--color-secondary);">ğŸ“¦ Zones Couvertes :</h4>
            <ul class="list-disc list-inside text-gray-400 text-sm space-y-1">
                <li>Ãle-de-France complÃ¨te ğŸ‡«ğŸ‡· (Min. : 60â‚¬ ğŸ¤)</li>
                <li>RÃ©gions limitrophes (28 / 60 / 45 / 02 / 89 / 27 / 10) (Min. : 200â‚¬ ğŸ¤)</li>
            </ul>
            <h4 class="font-bold mt-4" style="color: var(--color-secondary);">ğŸ“Œ ModalitÃ©s de commande :</h4>
            <ol class="list-decimal list-inside text-gray-400 text-sm space-y-1">
                <li>ğŸ†” VÃ©rification dâ€™identitÃ© obligatoire pour les nouveaux arrivants.</li>
                <li>âš ï¸ PrÃ©-commande lors des sessions de prise de commande.</li>
                <li>âœï¸ Envoie ta demande complÃ¨te avec commande + adresse + disponibilitÃ©s.</li>
                <li>ğŸ’µ RÃ¨glement en liquide uniquement.</li>
            </ol>
            <p class="text-gray-300 mt-3">ğŸ“¦ On se dÃ©place jusquâ€™Ã  lâ€™adresse de ton choix pour garantir une livraison sÃ©curisÃ©e & en toute discrÃ©tion.</p>
        `;
        
        return `
            <h2 class="text-3xl font-extrabold mb-6 text-white">ğŸ“² Contact & Protocoles</h2>
            
            <!-- 1. RÃ©seaux (PrioritÃ©) -->
            <div class="p-4 rounded-xl mb-4" style="background-color: #1f2937;">
                ${reseauxContent}
            </div>

            <!-- 2. Meet-up -->
            <div class="p-4 rounded-xl mb-4" style="background-color: #1f2937;">
                ${meetUpContent}
            </div>
            
            <!-- 3. Livraison / Envois Postaux (RegroupÃ©s) -->
            <div class="p-4 rounded-xl mb-4" style="background-color: #1f2937;">
                ${livraisonContent}
            </div>
        `;
    }

    /** Ã‰cran de SuccÃ¨s aprÃ¨s commande */
    function renderSuccessScreen() {
        const waLink = `https://wa.me/33759840764?text=Salut%20South%20Valley%2C%20mon%20code%20de%20vÃ©rification%20est%20${securityCode}%20!%20Mon%20ordre%20est%20envoyÃ©.%20%F0%9F%9A%80%F0%9F%8F%95%EF%B8%8F`;

        return `
            <div class="text-center p-6 text-white min-h-[60vh] flex flex-col justify-center items-center">
                <span class="text-7xl mb-6">âœ…</span>
                <h2 class="text-3xl font-extrabold mb-4" style="color: var(--color-primary);">ORDRE ENVOYÃ‰ !</h2>
                <p class="text-lg text-gray-300 mb-6">Votre ordre est en cours de traitement par notre Bot.</p>
                
                <div class="p-4 bg-gray-800 rounded-lg w-full max-w-xs mb-6">
                    <p class="text-xs text-gray-400">Votre Code de VÃ©rification Unique (Ã  utiliser sur WhatsApp) :</p>
                    <p class="text-2xl font-extrabold mt-1" style="color: var(--color-secondary);">${securityCode}</p>
                </div>

                <h3 class="text-xl font-bold mb-3" style="color: var(--color-secondary);">SUIVI IMMÃ‰DIAT ğŸš€</h3>
                <p class="text-sm text-gray-400 mb-4">Pour confirmer et obtenir les dÃ©tails de paiement/Meet-up :</p>
                
                <a href="${waLink}" target="_blank" class="w-full max-w-xs py-3 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 transition-colors flex items-center justify-center">
                    <span class="text-2xl mr-2">ğŸŸ¢</span> Contacter le Standard
                </a>
            </div>
        `;
    }


    /** Ajoute un produit au panier */
    function addToCart(id, name, price) {
        // Le ID est maintenant le Tier ID pour l'unicitÃ© dans le panier
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            // Utiliser le nom complet (Nom + Poids) pour le panier
            cart.push({ id, name, price, quantity: 1 });
        }
        updateCartDisplay();
        closeModal();
        showNotification(`Article ajoutÃ© au panier ! ğŸ›’`);
    }


    /** GÃ¨re la sÃ©lection du paiement et la politique associÃ©e */
    function setPayment(method) {
        document.getElementById('paymentMethod').value = method;
        const policyElement = document.getElementById('paymentPolicy');
        const policyContainer = document.getElementById('policyContainer');

        // Reset styles
        const cashBtn = document.getElementById('paymentCash');
        const cryptoBtn = document.getElementById('paymentCrypto');
        
        cashBtn.className = cashBtn.className.replace(' border-yellow-400 text-white', ' border-gray-700 text-gray-400');
        cryptoBtn.className = cryptoBtn.className.replace(' border-yellow-400 text-white', ' border-gray-700 text-gray-400');
        
        // Set new styles and policy text
        if (method === 'CASH') {
            cashBtn.className = cashBtn.className.replace(' border-gray-700 text-gray-400', ' border-yellow-400 text-white');
            policyElement.textContent = "CASH : Paiement au Rendez-vous (Meet-up) ou Ã  la Livraison. Le lieu sÃ©curisÃ© est confirmÃ© par le Bot aprÃ¨s validation. ğŸ¤";
        } else if (method === 'CRYPTO') {
            cryptoBtn.className = cryptoBtn.className.replace(' border-gray-700 text-gray-400', ' border-yellow-400 text-white');
            policyElement.innerHTML = "CRYPTO : Paiement Ã  l'avance pour les **ENVOIS POSTAUX**. <br> <b>SÃ©curitÃ© :</b> Remboursement Ã  **50%** en cas de saisie (Taux de passage garanti Ã  99% !).";
        }
        policyContainer.style.display = 'block';
    }


    /** GÃ¨re l'envoi vers WhatsApp */
    function submitOrderWA(event) {
        // EmpÃªcher le lien <a> d'ouvrir immÃ©diatement la page (on veut la logique ici)
        if (event) {
            event.preventDefault(); 
        }

        const telegramPseudo = document.getElementById('telegramPseudo').value;
        const contactNumber = document.getElementById('contactNumber').value;
        const shippingName = document.getElementById('shippingName').value;
        const shippingAddress = document.getElementById('shippingAddress').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const waLinkElement = document.getElementById('waLinkCheckout');

        if (!telegramPseudo || !contactNumber || !shippingName || !shippingAddress || !paymentMethod) {
            showNotification('Veuillez remplir tous les champs requis. ğŸš«', 'red');
            return;
        }

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        // Construction du message WhatsApp (rÃ©sumÃ© complet)
        const orderDetails = cart.map(item => `   - ${item.quantity}x ${item.name} (${item.price}â‚¬/u)`).join('\n');
        
        const waMessage = 
            `Salut SOUTH VALLEY ! ğŸŒ´\n\n` +
            `J'ai finalisÃ© mon ordre via le Command Center. Voici les dÃ©tails pour la suite :\n\n` +
            `ğŸ”’ Mon Code de VÃ©rification : ${securityCode}\n\n` +
            `--- RAPPEL DE COMMANDE ---\n` +
            `${orderDetails}\n` +
            `TOTAL: ${total}â‚¬\n\n` +
            `MÃ‰THODE: ${paymentMethod}\n` +
            `NOM CLIENT: ${shippingName}\n` +
            `ADRESSE: ${shippingAddress}\n` +
            `CONTACT: ${contactNumber} / TG: ${telegramPseudo}\n\n` +
            `Merci de confirmer la marche Ã  suivre pour l'envoi/meet-up. ğŸš€`;

        // Mise Ã  jour du lien A avec le message encodÃ©
        const encodedMessage = encodeURIComponent(waMessage);
        waLinkElement.href = `https://wa.me/33759840764?text=${encodedMessage}`;
        
        // Simuler l'envoi au Bot (pour le tracking et l'affichage du succÃ¨s)
        submitOrderBot(total, orderDetails);

        // Ouvrir WhatsApp aprÃ¨s l'envoi au bot
        window.open(waLinkElement.href, '_blank');
    }

    /** Simule l'envoi de la commande au bot (pour le tracking interne) */
    function submitOrderBot(total, summary) {
        const orderData = {
            client_telegram: document.getElementById('telegramPseudo').value,
            client_contact: document.getElementById('contactNumber').value,
            client_name: document.getElementById('shippingName').value,
            total: total + 'â‚¬',
            method: document.getElementById('paymentMethod').value,
            address: document.getElementById('shippingAddress').value,
            items: summary,
            security_code: securityCode,
            date: new Date().toISOString()
        };
        const jsonString = JSON.stringify(orderData, null, 2);

        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.sendData(jsonString);
        } else {
            console.warn("SDK Telegram non disponible. Commande simulÃ©e pour tracking.");
            console.log("--- JSON ENVOYÃ‰ Ã€ LA CONSOLE ---", jsonString);
        }

        // Afficher l'Ã©cran de succÃ¨s
        cart = [];
        updateCartDisplay();
        changeScreen('success');
    }


    /** Met Ã  jour la quantitÃ© d'un produit dans le panier */
    function updateQuantity(index, delta) {
        if (cart[index].quantity + delta > 0) {
            cart[index].quantity += delta;
        } else if (cart[index].quantity + delta === 0) {
            cart.splice(index, 1);
        }
        changeScreen('cart');
        updateCartDisplay();
    }

    /** Retire un produit du panier */
    function removeItem(index) {
        const removedName = cart[index].name;
        cart.splice(index, 1);
        changeScreen('cart');
        updateCartDisplay();
        showNotification(`${removedName} retirÃ© du panier. ğŸ—‘ï¸`);
    }

    /** Affiche une petite notification */
    function showNotification(message, color = 'green') {
        const notif = document.createElement('div');
        notif.textContent = message;
        notif.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-sm text-white shadow-xl transition-opacity duration-300 ${color === 'green' ? 'bg-green-600' : color === 'red' ? 'bg-red-600' : 'bg-yellow-600'}`;
        document.body.appendChild(notif);
        setTimeout(() => {
            notif.style.opacity = '0';
            setTimeout(() => notif.remove(), 300);
        }, 3000);
    }

    // --- INITIALISATION ---
    
    // Fonction d'initialisation appelÃ©e aprÃ¨s un court dÃ©lai pour simuler le chargement
    function initializeApp() {
        // Cacher l'Ã©cran de chargement
        document.getElementById('loadingScreen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            // Tenter de dÃ©marrer la vidÃ©o de logo (ne dÃ©pend plus de l'autoplay)
            const videoElement = document.getElementById('logoVideo');
            videoElement.play().catch(e => console.log("VidÃ©o de transition non lancÃ©e (OK sur mobile)."));

            // Initialiser l'affichage
            changeScreen('menu');
            updateCartDisplay();
            
            // Si le SDK est lÃ , initialiser l'app Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                // Adapter la couleur de l'app au thÃ¨me Telegram
                document.body.style.backgroundColor = window.Telegram.WebApp.themeParams.bg_color || '#111827';
            }
        }, 500); // Temps pour la transition
    }

    // Lancer l'initialisation aprÃ¨s le chargement du corps pour simuler un dÃ©marrage pro
    document.addEventListener('DOMContentLoaded', () => {
        // Utiliser un simple timeout court pour garantir le dÃ©marrage
        setTimeout(initializeApp, 1500); 
    });

</script>
</body>
</html>
